[[{"l":"Welcome","p":["Welcome to the AutoPilot documentation! This is your go-to resource for all things related to AutoPilot. Please note that our documentation is currently a work in progress. We are continuously adding new content and improving existing articles to provide you with the best information possible. Stay tuned for more updates!"]}],[{"i":"add-custom-boot-hook-to-mntjrc-commshooksbootd","l":"Add Custom Boot Hook to /mnt/jrc-comms/hooks/boot.d","p":["This guide explains how to add a custom boot hook to /mnt/jrc-comms/hooks/boot.d/ in applications that execute scripts in numerical order. Follow these steps to ensure proper execution order and functionality.","We assume you have root access to modify files in /mnt/jrc-comms/hooks/boot.d/."]},{"l":"Create Custom Boot Hook"},{"l":"1. Create Your Script","p":["Create a new shell script with a filename starting with 99-(to ensure it runs last). For example:"]},{"l":"2. Set Permissions and Ownership","p":["Make the script executable and ensure itâ€™s owned by root:"]},{"l":"3. Verify Execution Order","p":["The application runs scripts in ascending order based on their numeric prefixes. Scripts added to /mnt/jrc-comms/hooks/boot.d will be injected into /opt/jrc/hooks/boot.d based on script prefix automatically. For example:","05-mount-recovery-mount runs first (found in /opt/jrc/hooks/boot.d)","10-cluster-clean runs next (found in /opt/jrc/hooks/boot.d)","99-custom-task runs last (added to /mnt/jrc-comms/hooks/boot.d)","Key rules:","Prefixes determine execution order (e.g., 00- to 99-)","Use two-digit numbering for clarity (e.g., 05-, 10-, 99-)","Scripts with the same prefix may execute in lexicographical order, but avoid ambiguity by using unique prefixes","Scripts added to /mnt/jrc-comms/hooks/boot.d will persist AMI upgrades, stack clones, etc.","By following this structure, you can extend the boot process with custom logic while maintaining predictable execution order."]},{"l":"Example Walkthrough","p":["To log system time at the end of the boot process:"]},{"l":"Troubleshooting Tips"},{"i":"1-test-your-script-manually-before-relying-on-the-boot-process","l":"1. Test your script manually before relying on the boot process:"},{"i":"2-check-logs-for-errors-eg-varlogsyslog-or-journalctl","l":"2. Check logs for errors (e.g., /var/log/syslog or journalctl)"},{"i":"3-validate-script-syntax-using","l":"3. Validate script syntax using:"},{"l":"Alternative to fstab Mounting Using Boot Hook Script","p":["AutoPilot's boot hook system provides a more reliable alternative to /etc/fstab for bind mounts within dynamic environments, particularly when dealing with paths that might not be available during early boot stages.","The following is an example of how you would implement a boot hook script to create hard links. Typically this would be accomplished within /etc/fstab."]},{"l":"Boot Hook Script Implementation"},{"i":"1-create-mntjrc-commshooksbootd99-links-script","l":"1. Create /mnt/jrc-comms/hooks/boot.d/99-links Script","p":["Creates bind mounts after filesystems are available"]},{"l":"2. Set Permissions"},{"l":"Verification"},{"i":"1-validate-script-syntax","l":"1. Validate script syntax:"},{"i":"2-check-active-mounts","l":"2. Check active mounts:"}],[{"l":"Onboard Magento With Deployer","p":["This guide will walk you through onboarding your existing Magento Store onto the AutoPilot platform using Deployer. We will initially deploy a sample codebase onto a new deployment. Although we demonstrate using PHP Deployer, you can use any deployment tool you prefer. Filesystem requirements are outlined in the Filesystem Requirements section.","We assume the store's domain name is example.com."]},{"l":"Create Deployment","p":["Create a new deployment through the AutoPilot dashboard that matches your Magento version to ensure compatibility with services like PHP and MySQL. If your Magento version is unavailable, mix and match service versions to meet your requirements. If provisioning fails, open a support ticket for assistance.","After provisioning, visit the Security tab to whitelist your IPv4 address and SSH key. Find your public IP at ip.jetrails.com.","My IP Address","Your shell access command is available on the Overview tab.","We assume the shell access command is ssh jrc-3p7i-376i@10.10.10.10."]},{"l":"Deployer File","p":["We created an AutoPilot recipe for Deployer to aid the deployment process. Find it on GitHub at jetrails/deployer-autopilot. A sample deployer recipe is in the examples folder, e.g., magento2.php.","Modify the following settings in the deployer file with your values:","We assume the repository is git@github.com:example/example.git and you use deploy keys for GitHub authentication.","Find your cluster user's public SSH key by connecting to your deployment via SSH and running:"]},{"l":"Import Database","p":["Upload your database dump to your deployment using rsync:","Your database dump is named database-dump.sql.","Import the database dump into your MySQL database. Find your database name in the AutoPilot dashboard's Overview tab.","We assume the database name is vo889841yc249h86.","Run the following command:"]},{"l":"Upload Media Files","p":["Upload your media files using rsync:","Your local media folder is located at /path/to/media/.","The --no-p, --no-g, and --chmod=ugo=rwX flags ensure proper permissions on the media files."]},{"l":"Deploy Codebase","p":["Once you have your deployer file, database, and media files ready, deploy your codebase:","If you integrated our example recipe, services like php-fpm and varnish will restart automatically after a successful deployment."]},{"l":"Filesystem Requirements","p":["NGINX and PHP-FPM run under the www-data user and group, therefore, all publicly accessible files must be readable by the www-data user. Additionally, any directories or files that need to be writable must also have write permissions for the www-data user. This is easy to do with Deployer's acl strategy, which leverages setfacl to set extended permissions.","To ensure proper ownership and permissions for the codebase files, follow these guidelines:","The codebase files should be owned by jrc-3p7i-376i:jetrails.","The codebase files should have the permissions u=rwX,g=u,o=rX.","The www-data user should have rwX permissions on writable directories such as var.","If you find yourself needing to set ownership and permissions manually, then follow the outlined steps. Use the following commands to set the ownership and permissions:","To grant the www-data user the necessary write permissions, use these commands:"]}],[{"l":"Patches","p":["Patches are categorized as Critical, Recommended, or Optional, indicating their severity and the urgency of application. This classification is reflected in the last character of the patch's name.","Severity","Description","Critical","Must be applied to all environments as soon as possible.","Recommended","Includes important fixes and is recommended for all environments, but can be applied later.","Optional","Applied only if specifically requested and does not affect performance or functionality."]}],[{"l":"P001C","p":["Fixes data persistence issue with OpenSearch and Redis."]},{"l":"Description","p":["We first noticed the issue that OpenSearch and Redis session data was being deleted every time it was taken out of hibernation. As a result, the site had to be re-indexed upon each wake-up.","The root cause lies in the helper scripts that run on boot. These scripts manage version changes for OpenSearch and Redis and are also triggered by CloudFormation (CFN) when a version update is requested.","In some cases, we need to delete persistent data to prevent compatibility issues between old data and new software versions. However, the problem is that the current boot process clears the data without checking if a version change has actually occurred."]},{"l":"Impact","p":["All-In-One (AIO) Servers","Web Layer","Redis Session Layer","Redis Cache Layer","OpenSearch Layer"]},{"l":"Changes","p":["The following files are patched on the servers receiving the patch:","/opt/jrc/sbin/change-search-version","/opt/jrc/sbin/change-redis-session-version","/opt/jrc/sbin/change-redis-cache-version"]},{"l":"If You Accept","p":["During your chosen maintenance window, the patch will be applied to all targeted servers. New Amazon Machine Images (AMIs) will be generated for each of the servers involved, and these new AMIs will be used to replace the current servers. Downtime should be minimal and take less than 10 minutes to restore service."]},{"l":"If You Reject","p":["OpenSearch and Redis session data will continue to be deleted as a side effect every time the deployment is taken out of hibernation. This will result in the need to re-index OpenSearch upon each wake-up and loss of session data."]}],[{"l":"P002R","p":["PHP performance improvements."]},{"l":"Description","p":["The opcache.max_file_size directive determines the maximum file size that can be cached by OPcache. Setting this value to zero allows all files to be cached, which can significantly improve the Time To First Byte (TTFB) metric. Previously, this value was limited to avoid caching large files deemed unnecessary for application functionality. However, further analysis has shown that removing this limitation enhances performance without adverse effects."]},{"l":"Impact","p":["Web Layer"]},{"l":"Changes","p":["The opcache.max_file_size directive will be updated to zero."]},{"l":"If You Accept","p":["During your chosen maintenance window, the patch will be applied. PHP-FPM will be restarted on the web tier to apply the changes. No downtime is expected since we are only restarting the PHP-FPM service."]},{"l":"If You Reject","p":["The current configuration will remain unchanged, and no performance improvements will be applied."]}],[{"l":"P003O","p":["Removed SSH keys count limit."]},{"l":"Description","p":["This patch increases the maximum number of SSH keys allowed by transitioning from a single advanced SSM parameter to multiple standard SSM parameters. Each SSH key is now stored individually, removing the previous 8k size limitation."]},{"l":"Impact","p":["All-In-One (AIO) Servers","Jump Host Servers","Web Layer"]},{"l":"Changes","p":["Public keys in the advanced SSM parameter are split into multiple standard SSM parameters.","The sync-ssh-keys script is patched on jump and web leader instances.","Cloudformation template is updated to reflect the new method of storing SSH keys:"]},{"l":"If You Accept","p":["The deployment will support effectively unlimited SSH keys. During your chosen maintenance window, the patch will be applied to all targeted servers. New Amazon Machine Images (AMIs) will be generated for each of the servers involved, and these new AMIs will be used to replace the current servers. Downtime should be minimal and take less than 10 minutes to restore service."]},{"l":"If You Reject","p":["No performance or functionality degradation is expected, but the deployment will not benefit from the increased SSH key limit."]}],[{"l":"P004C","p":["Daily Backups For RDS With Standard Retention"]},{"l":"Description","p":["This patch fixes an issue regarding daily backup retention with RDS clusters. With the standard retention policy, RDS clusters currently have a daily backup retention of 1 day. This patch will increase the daily backup retention to 35 days, allowing for better data recovery options."]},{"l":"Impact","p":["RDS Database Layer"]},{"l":"Changes","p":["Simple tagging change to the RDS cluster"]},{"l":"If You Accept","p":["RDS will increase it's daily backup retention from 1 day to 35 days."]},{"l":"If You Reject","p":["RDS will continue to have a daily backup retention of 1 day."]}]]